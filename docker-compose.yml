services:
# Postgres DB
  postgres:
    image: postgres:16
    container_name: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: dan
      POSTGRES_PASSWORD: dan
      POSTGRES_DB: fit
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

# Redash Postgres DB
  redash_postgres:
    image: postgres:16
    container_name: redash_postgres
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: redash
      POSTGRES_PASSWORD: redash
      POSTGRES_DB: redash
    volumes:
      - redash_postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

# Redash Redis
  redash_redis:
    image: redis:7-alpine
    container_name: redash_redis
    volumes:
      - redash_redis_data:/data
    restart: unless-stopped

# Redash Server
  redash_server:
    image: redash/redash:latest
    container_name: redash_server
    depends_on:
      - redash_postgres
      - redash_redis
    ports:
      - "5000:5000"
    environment:
      REDASH_DATABASE_URL: postgresql://redash:redash@redash_postgres:5432/redash
      REDASH_REDIS_URL: redis://redash_redis:6379/0
      REDASH_COOKIE_SECRET: ${REDASH_COOKIE_SECRET}
      REDASH_SECRET_KEY: ${REDASH_SECRET_KEY}
    command: server
    restart: unless-stopped

# Redash Scheduler
  redash_scheduler:
    image: redash/redash:latest
    container_name: redash_scheduler
    depends_on:
      - redash_server
    environment:
      REDASH_DATABASE_URL: postgresql://redash:redash@redash_postgres:5432/redash
      REDASH_REDIS_URL: redis://redash_redis:6379/0
      REDASH_COOKIE_SECRET: ${REDASH_COOKIE_SECRET}
      REDASH_SECRET_KEY: ${REDASH_SECRET_KEY}
    command: scheduler
    restart: unless-stopped

# Redash Worker
  redash_worker:
    image: redash/redash:latest
    container_name: redash_worker
    depends_on:
      - redash_server
    environment:
      REDASH_DATABASE_URL: postgresql://redash:redash@redash_postgres:5432/redash
      REDASH_REDIS_URL: redis://redash_redis:6379/0
      REDASH_COOKIE_SECRET: ${REDASH_COOKIE_SECRET}
      REDASH_SECRET_KEY: ${REDASH_SECRET_KEY}
      QUEUES: queries,scheduled_queries,schemas
    command: worker
    restart: unless-stopped

# Adminer for db
  adminer:
    image: adminer:latest
    container_name: adminer
    depends_on:
      - postgres
    ports:
      - "18081:8080"
    restart: unless-stopped

# Python app
  generator:
    build:
      context: .
      dockerfile: src/Dockerfile
    container_name: generator
    depends_on:
      - postgres
    environment:
      DATABASE_URL: postgresql://dan:dan@postgres:5432/fit
      INTERVAL_SECONDS: 1
      PYTHONUNBUFFERED: 1
    restart: unless-stopped

# Jupyter Notebook
  jupyter:
    image: jupyter/scipy-notebook:latest
    container_name: jupyter
    depends_on:
      - postgres
    ports:
      - "8888:8888"
    volumes:
      - ./notebooks:/home/jovyan/work
    environment:
      JUPYTER_TOKEN: dev
    command: start-notebook.sh --NotebookApp.token=dev --NotebookApp.password=''
    restart: unless-stopped

volumes:
  postgres_data:
  redash_postgres_data:
  redash_redis_data: